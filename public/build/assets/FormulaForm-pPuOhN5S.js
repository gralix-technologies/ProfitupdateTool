import{r as n,j as e}from"./app-BkeQkwCz.js";import{I as xe}from"./IconRefresh-U6chIQJB.js";import{h as Y,o as pe,f as be,l as je,k as oe,u as ge}from"./AppLayout-QgBVyLMh.js";import{I as ye}from"./IconAlertCircle-WImK9GUn.js";import{I as Ne}from"./IconMath-BtpA-xAv.js";import{C as te,a as ae,b as fe,c as ve}from"./card-DYiue1Z-.js";import{I as Z}from"./IconCircleCheck-72xOlUga.js";import O,{ApiError as X}from"./apiClient-B5VLjQ69.js";import{I as we}from"./IconPlayerPlay-QXgf9gYp.js";import{I as Ce}from"./IconCopy-EHB0SucX.js";import{I as ke}from"./IconDownload-DpSVhOrW.js";import{I as le,a as ne}from"./IconChevronUp-CSfYcfYK.js";/**
 * @license @tabler/icons-react v3.35.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */const Se=[["path",{d:"M3 19a9 9 0 0 1 9 0a9 9 0 0 1 9 0",key:"svg-0"}],["path",{d:"M3 6a9 9 0 0 1 9 0a9 9 0 0 1 9 0",key:"svg-1"}],["path",{d:"M3 6l0 13",key:"svg-2"}],["path",{d:"M12 6l0 13",key:"svg-3"}],["path",{d:"M21 6l0 13",key:"svg-4"}]],Q=Y("outline","book","Book",Se);/**
 * @license @tabler/icons-react v3.35.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fe=[["path",{d:"M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0",key:"svg-0"}],["path",{d:"M10 10l4 4m0 -4l-4 4",key:"svg-1"}]],K=Y("outline","circle-x","CircleX",Fe);/**
 * @license @tabler/icons-react v3.35.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */const _e=[["path",{d:"M20 8.04l-12.122 12.124a2.857 2.857 0 1 1 -4.041 -4.04l12.122 -12.124",key:"svg-0"}],["path",{d:"M7 13h8",key:"svg-1"}],["path",{d:"M19 15l1.5 1.6a2 2 0 1 1 -3 0l1.5 -1.6z",key:"svg-2"}],["path",{d:"M15 3l6 6",key:"svg-3"}]],Ee=Y("outline","test-pipe","TestPipe",_e);function Ie({value:s,onChange:a,supportedOperations:o=[],placeholder:d="Enter formula expression...",className:b="",availableFields:i={},onInsertField:N=null,onInsertFunction:r=null,validationResult:x=null,onValidate:m=null}){var H;const[l,F]=n.useState(!1),[I,_]=n.useState(0),[C,R]=n.useState([]),[u,k]=n.useState(!1),[T,U]=n.useState(!1),[j,y]=n.useState(!0),g=n.useRef(null),A=c=>{const p=c.target.value,M=c.target.selectionStart;a(p),_(M),j&&m&&p.trim()&&setTimeout(()=>m(p),500);const D=p.substring(0,M).split(/[\s\(\)\+\-\*\/\,]/).pop();if(D&&D.length>0){const L=o.filter(G=>G.toLowerCase().startsWith(D.toLowerCase()));L.length>0?(R(L),F(!0)):F(!1)}else F(!1)},f=c=>{const p=g.current,M=p.selectionStart,E=p.selectionEnd,D=s.substring(0,M),L=s.substring(E),G=D+c+L;a(G),setTimeout(()=>{p.focus(),p.setSelectionRange(M+c.length,M+c.length)},0)},v=c=>{const p=c+"()";f(p),U(!1)},w=c=>{f(c),k(!1)},V=c=>{f(c)},B=()=>{let c=s.replace(/\+/g," + ").replace(/\-/g," - ").replace(/\*/g," * ").replace(/\//g," / ").replace(/\s+/g," ").trim();a(c)},W=()=>{a(""),g.current&&g.current.focus()},$=(()=>{if(!s)return{level:"Simple",score:0};const c=(s.match(/\b(SUM|AVG|COUNT|MIN|MAX|IF|CASE|RATIO|PERCENTAGE|MOVING_AVG|GROWTH_RATE)\b/g)||[]).length,p=(s.match(/[+\-*/=<>()]/g)||[]).length,M=(s.match(/\([^)]*\(/g)||[]).length,E=c*2+p*1+M*3;return E<=3?{level:"Simple",score:E}:E<=8?{level:"Medium",score:E}:E<=15?{level:"Complex",score:E}:{level:"Very Complex",score:E}})();return e.jsxs("div",{children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"border rounded-lg bg-white",children:e.jsx("textarea",{ref:g,value:s,onChange:A,placeholder:d,className:`form-control font-monospace ${b}`,style:{minHeight:"120px",resize:"vertical",border:"none",outline:"none"},rows:5})}),s&&e.jsxs("div",{className:"d-flex justify-content-between align-items-center mt-2",children:[e.jsxs("div",{className:"d-flex gap-3",children:[e.jsxs("small",{className:"text-muted",children:["Characters: ",s.length]}),e.jsxs("small",{className:"text-muted",children:["Complexity: ",e.jsx("span",{className:`badge ${$.level==="Simple"?"bg-success":$.level==="Medium"?"bg-warning":$.level==="Complex"?"bg-danger":"bg-dark"}`,children:$.level})]})]}),e.jsxs("div",{className:"btn-group btn-group-sm",children:[e.jsxs("button",{type:"button",className:"btn btn-outline-secondary",onClick:B,disabled:!s.trim(),children:[e.jsx(xe,{size:14,className:"me-1"}),"Format"]}),e.jsxs("button",{type:"button",className:"btn btn-outline-danger",onClick:W,disabled:!s.trim(),children:[e.jsx(pe,{size:14,className:"me-1"}),"Clear"]})]})]}),x&&e.jsx("div",{className:"mt-2",children:x.valid?e.jsxs("div",{className:"alert alert-success alert-sm",children:[e.jsx(be,{size:16,className:"me-2"}),"Formula is valid",x.result!==void 0&&e.jsxs("span",{className:"ms-2",children:["(Result: ",x.result,")"]})]}):e.jsxs("div",{className:"alert alert-danger alert-sm",children:[e.jsx(ye,{size:16,className:"me-2"}),((H=x.errors)==null?void 0:H.join(", "))||"Formula validation failed"]})}),l&&C.length>0&&e.jsx("div",{className:"position-absolute top-100 start-0 w-100 bg-white border rounded shadow-lg mt-1",style:{zIndex:1e3},children:e.jsx("div",{className:"p-2",style:{maxHeight:"200px",overflowY:"auto"},children:C.map(c=>e.jsxs("button",{type:"button",className:"btn btn-sm btn-outline-primary w-100 text-start mb-1",onClick:()=>v(c),children:[e.jsx("strong",{children:c}),e.jsx("small",{className:"text-muted ms-2",children:c==="SUM"?"Sum values":c==="AVG"?"Average values":c==="COUNT"?"Count records":c==="IF"?"Conditional logic":"Function"})]},c))})})]}),e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsxs("div",{className:"d-flex align-items-center justify-content-between",children:[e.jsxs("h6",{className:"card-title mb-0",children:[e.jsx(Ne,{size:16,className:"me-2"}),"Quick Insert Tools"]}),e.jsxs("div",{className:"form-check form-switch",children:[e.jsx("input",{className:"form-check-input",type:"checkbox",id:"autoValidate",checked:j,onChange:c=>y(c.target.checked)}),e.jsx("label",{className:"form-check-label small",htmlFor:"autoValidate",children:"Auto-validate"})]})]})}),e.jsxs("div",{className:"card-body",children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("h6",{className:"small text-muted mb-2",children:"Functions:"}),e.jsx("div",{className:"d-flex flex-wrap gap-1",children:o.map(c=>e.jsx("button",{type:"button",className:"btn btn-outline-primary btn-sm",onClick:()=>v(c),title:`Insert ${c} function`,children:c},c))})]}),Object.keys(i).length>0&&e.jsxs("div",{className:"mb-3",children:[e.jsx("h6",{className:"small text-muted mb-2",children:"Available Fields:"}),e.jsx("div",{className:"d-flex flex-wrap gap-1",children:Object.keys(i).map(c=>e.jsx("button",{type:"button",className:"btn btn-outline-success btn-sm",onClick:()=>w(c),title:i[c],children:c},c))})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("h6",{className:"small text-muted mb-2",children:"Operators:"}),e.jsx("div",{className:"d-flex flex-wrap gap-1",children:[{op:"+",desc:"Add"},{op:"-",desc:"Subtract"},{op:"*",desc:"Multiply"},{op:"/",desc:"Divide"},{op:"=",desc:"Equals"},{op:">",desc:"Greater than"},{op:"<",desc:"Less than"},{op:"(",desc:"Open parenthesis"},{op:")",desc:"Close parenthesis"}].map(({op:c,desc:p})=>e.jsx("button",{type:"button",className:"btn btn-outline-warning btn-sm",onClick:()=>V(c),title:p,children:c},c))})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("h6",{className:"small text-muted mb-2",children:"Quick Templates:"}),e.jsxs("div",{className:"d-flex flex-wrap gap-1",children:[e.jsx("button",{type:"button",className:"btn btn-outline-info btn-sm",onClick:()=>f("SUM()"),title:"Sum template",children:"SUM()"}),e.jsx("button",{type:"button",className:"btn btn-outline-info btn-sm",onClick:()=>f("AVG()"),title:"Average template",children:"AVG()"}),e.jsx("button",{type:"button",className:"btn btn-outline-info btn-sm",onClick:()=>f("IF(condition, true_value, false_value)"),title:"If statement template",children:"IF()"}),e.jsx("button",{type:"button",className:"btn btn-outline-info btn-sm",onClick:()=>f("RATIO(numerator, denominator)"),title:"Ratio calculation template",children:"RATIO()"})]})]})]})]})]})}const re=({children:s,variant:a="primary",size:o="md",disabled:d=!1,className:b="",onClick:i,type:N="button",...r})=>{const x="btn",m={primary:"btn-primary",secondary:"btn-secondary",outline:"btn-outline-primary",ghost:"btn-ghost",danger:"btn-danger"},l={sm:"btn-sm",md:"",lg:"btn-lg"},F=[x,m[a]||m.primary,l[o],b].filter(Boolean).join(" ");return e.jsx("button",{type:N,className:F,disabled:d,onClick:i,...r,children:s})},Te=({children:s,variant:a="primary",className:o="",...d})=>{const b="badge",i={primary:"bg-primary",secondary:"bg-secondary",success:"bg-success",danger:"bg-danger",warning:"bg-warning",info:"bg-info"},N=[b,i[a]||i.primary,o].filter(Boolean).join(" ");return e.jsx("span",{className:N,...d,children:s})},Me=({type:s="text",className:a="",placeholder:o="",value:d,onChange:b,disabled:i=!1,...N})=>e.jsx("input",{type:s,className:`form-control ${a}`,placeholder:o,value:d,onChange:b,disabled:i,...N});/**
 * @license lucide-react v0.544.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ae=s=>s.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase(),ze=s=>s.replace(/^([A-Z])|[\s-_]+(\w)/g,(a,o,d)=>d?d.toUpperCase():o.toLowerCase()),ce=s=>{const a=ze(s);return a.charAt(0).toUpperCase()+a.slice(1)},de=(...s)=>s.filter((a,o,d)=>!!a&&a.trim()!==""&&d.indexOf(a)===o).join(" ").trim(),Re=s=>{for(const a in s)if(a.startsWith("aria-")||a==="role"||a==="title")return!0};/**
 * @license lucide-react v0.544.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */var Oe={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};/**
 * @license lucide-react v0.544.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const De=n.forwardRef(({color:s="currentColor",size:a=24,strokeWidth:o=2,absoluteStrokeWidth:d,className:b="",children:i,iconNode:N,...r},x)=>n.createElement("svg",{ref:x,...Oe,width:a,height:a,stroke:s,strokeWidth:d?Number(o)*24/Number(a):o,className:de("lucide",b),...!i&&!Re(r)&&{"aria-hidden":"true"},...r},[...N.map(([m,l])=>n.createElement(m,l)),...Array.isArray(i)?i:[i]]));/**
 * @license lucide-react v0.544.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const P=(s,a)=>{const o=n.forwardRef(({className:d,...b},i)=>n.createElement(De,{ref:i,iconNode:a,className:de(`lucide-${Ae(ce(s))}`,`lucide-${s}`,d),...b}));return o.displayName=ce(s),o};/**
 * @license lucide-react v0.544.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ve=[["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",key:"1nb95v"}],["line",{x1:"8",x2:"16",y1:"6",y2:"6",key:"x4nwl0"}],["line",{x1:"16",x2:"16",y1:"14",y2:"18",key:"wjye3r"}],["path",{d:"M16 10h.01",key:"1m94wz"}],["path",{d:"M12 10h.01",key:"1nrarc"}],["path",{d:"M8 10h.01",key:"19clt8"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M8 14h.01",key:"6423bh"}],["path",{d:"M12 18h.01",key:"mhygvu"}],["path",{d:"M8 18h.01",key:"lrp35t"}]],J=P("calculator",Ve);/**
 * @license lucide-react v0.544.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $e=[["path",{d:"M3 3v16a2 2 0 0 0 2 2h16",key:"c24i48"}],["path",{d:"M18 17V9",key:"2bz60n"}],["path",{d:"M13 17V5",key:"1frdt8"}],["path",{d:"M8 17v-3",key:"17ska0"}]],ie=P("chart-column",$e);/**
 * @license lucide-react v0.544.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Le=[["line",{x1:"19",x2:"5",y1:"5",y2:"19",key:"1x9vlm"}],["circle",{cx:"6.5",cy:"6.5",r:"2.5",key:"4mh3h7"}],["circle",{cx:"17.5",cy:"17.5",r:"2.5",key:"1mdrzq"}]],Pe=P("percent",Le);/**
 * @license lucide-react v0.544.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ue=[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]],He=P("plus",Ue);/**
 * @license lucide-react v0.544.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ge=[["path",{d:"m21 21-4.34-4.34",key:"14j7rj"}],["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}]],Be=P("search",Ge);/**
 * @license lucide-react v0.544.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const We=[["path",{d:"M16 7h6v6",key:"box55l"}],["path",{d:"m22 7-8.5 8.5-5-5L2 17",key:"1t1m79"}]],qe=P("trending-up",We);function Xe({onSelect:s}){const[a,o]=n.useState([]),[d,b]=n.useState([]),[i,N]=n.useState(""),[r,x]=n.useState(""),[m,l]=n.useState(!0);n.useEffect(()=>{F()},[]),n.useEffect(()=>{I()},[a,i,r]);const F=async()=>{try{const k=await(await fetch("/formulas/templates")).json();o(k.templates||[])}catch(u){console.error("Failed to fetch templates:",u)}finally{l(!1)}},I=()=>{let u=a;i&&(u=u.filter(k=>k.name.toLowerCase().includes(i.toLowerCase())||k.description.toLowerCase().includes(i.toLowerCase())||k.expression.toLowerCase().includes(i.toLowerCase()))),r&&(u=u.filter(k=>k.category===r)),b(u)},_=[...new Set(a.map(u=>u.category))],C=u=>({Aggregation:ie,Mathematical:J,Financial:qe,Statistical:ie,Conditional:He,Percentage:Pe})[u]||J,R=u=>({Aggregation:"bg-blue-100 text-blue-800",Mathematical:"bg-green-100 text-green-800",Financial:"bg-purple-100 text-purple-800",Statistical:"bg-orange-100 text-orange-800",Conditional:"bg-yellow-100 text-yellow-800",Percentage:"bg-pink-100 text-pink-800"})[u]||"bg-gray-100 text-gray-800";return m?e.jsx(te,{children:e.jsx(ae,{className:"pt-6",children:e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"})})})}):e.jsxs(te,{children:[e.jsxs(fe,{children:[e.jsx(ve,{className:"text-lg",children:"Formula Templates"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(Be,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-4 w-4"}),e.jsx(Me,{placeholder:"Search templates...",value:i,onChange:u=>N(u.target.value),className:"pl-10"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(re,{variant:r===""?"default":"outline",size:"sm",onClick:()=>x(""),children:"All"}),_.map(u=>e.jsx(re,{variant:r===u?"default":"outline",size:"sm",onClick:()=>x(u),children:u},u))]})]})]}),e.jsx(ae,{children:e.jsxs("div",{className:"space-y-3 max-h-96 overflow-y-auto",children:[d.map((u,k)=>{const T=C(u.category);return e.jsxs("div",{className:"border rounded-lg p-4 hover:bg-gray-50 cursor-pointer transition-colors",onClick:()=>s(u),children:[e.jsxs("div",{className:"flex items-start justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(T,{className:"h-4 w-4 text-gray-600"}),e.jsx("h4",{className:"font-medium text-gray-900",children:u.name})]}),e.jsx(Te,{className:R(u.category),children:u.category})]}),e.jsx("div",{className:"mb-2",children:e.jsx("code",{className:"bg-gray-100 px-2 py-1 rounded text-sm font-mono",children:u.expression})}),e.jsx("p",{className:"text-sm text-gray-600",children:u.description})]},k)}),d.length===0&&e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(J,{className:"h-12 w-12 mx-auto mb-4 text-gray-300"}),e.jsx("p",{children:"No templates found matching your criteria."})]})]})})]})}function Qe({result:s}){if(!s)return null;const{valid:a,errors:o=[],warnings:d=[],execution_result:b,execution_error:i}=s;return e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{className:"d-flex align-items-center mb-3",children:a?e.jsxs(e.Fragment,{children:[e.jsx(Z,{size:20,className:"text-success me-2"}),e.jsx("span",{className:"text-success fw-bold",children:"✅ Formula is valid and ready to use!"})]}):e.jsxs(e.Fragment,{children:[e.jsx(K,{size:20,className:"text-danger me-2"}),e.jsx("span",{className:"text-danger fw-bold",children:"❌ Formula has errors"})]})}),o&&o.length>0&&e.jsxs("div",{className:"alert alert-danger",children:[e.jsxs("div",{className:"d-flex align-items-center mb-2",children:[e.jsx(K,{size:16,className:"me-2"}),e.jsx("strong",{children:"Validation Errors:"})]}),e.jsx("ul",{className:"mb-0",children:o.map((N,r)=>e.jsx("li",{children:N},r))})]}),d&&d.length>0&&e.jsxs("div",{className:"alert alert-warning",children:[e.jsxs("div",{className:"d-flex align-items-center mb-2",children:[e.jsx(je,{size:16,className:"me-2"}),e.jsx("strong",{children:"Warnings:"})]}),e.jsx("ul",{className:"mb-0",children:d.map((N,r)=>e.jsx("li",{children:N},r))})]}),a&&(!o||o.length===0)&&(!d||d.length===0)&&e.jsxs("div",{className:"alert alert-success",children:[e.jsxs("div",{className:"d-flex align-items-center mb-2",children:[e.jsx(oe,{size:16,className:"me-2"}),e.jsx("strong",{children:"Formula validation successful!"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"mb-2",children:"✅ Formula syntax is correct and ready to use."}),b!=null&&e.jsxs("div",{className:"mt-2",children:[e.jsx("span",{className:"fw-bold",children:"Sample execution result: "}),e.jsx("span",{className:"badge bg-secondary",children:b})]}),i&&e.jsxs("div",{className:"mt-2 text-danger",children:[e.jsx("span",{className:"fw-bold",children:"Execution error: "}),e.jsx("span",{children:i})]})]})]})]})}const Je=()=>{const{showSuccess:s,showError:a,showWarning:o,showInfo:d}=ge(),b=n.useCallback((r,x={})=>{const{showToast:m=!0,fallbackMessage:l="An unexpected error occurred",logError:F=!0,customHandler:I=null}=x;if(F&&(console.error("API Error:",r),r instanceof X&&console.error("Error Details:",r.getDebugInfo())),I){I(r);return}if(!m)return;let _=l,C="Error";r instanceof X?(_=r.getUserMessage(),r.isNetworkError?C="Connection Error":r.isValidationError?C="Validation Error":r.isServerError?C="Server Error":r.isClientError&&(C="Request Error")):r instanceof Error?_=r.message:typeof r=="string"&&(_=r),r instanceof X&&r.isValidationError?o(_,C):a(_,C)},[a,o]),i=n.useCallback((r,x="Success")=>{s(r,x)},[s]),N=n.useCallback(async(r,x={})=>{try{return await r()}catch(m){throw b(m,x),m}},[b]);return{handleError:b,handleSuccess:i,handleAsync:N,showSuccess:s,showError:a,showWarning:o,showInfo:d}},Ze=()=>{const[s,a]=n.useState(!1),[o,d]=n.useState(null),[b,i]=n.useState(null),[N,r]=n.useState({}),{handleSuccess:x,handleAsync:m}=Je(),l=n.useCallback(async(j,y=null,g=null)=>(a(!0),m(async()=>{const f=(await O.post("/formulas/test",{expression:j,product_id:y,sample_data:g||[],use_real_data:!1})).data;return d(f),f.valid&&x(f.message||"Formula is valid","Validation Success"),f},{showToast:!1}).finally(()=>{a(!1)})),[m,x]),F=n.useCallback(async(j,y,g=null)=>(a(!0),m(async()=>{const A=await O.post("/formulas/test",{expression:j,product_id:y,sample_data:g,use_real_data:!0});return i(A.data),A.data},{showToast:!1}).finally(()=>{a(!1)})),[m]),I=n.useCallback(async(j=null)=>m(async()=>{const y=j?`?product_id=${j}`:"",g=await O.get(`/formulas/field-suggestions${y}`);return g.data.fields||g.data}),[m]),_=n.useCallback(async j=>j?m(async()=>{const y=await O.get(`/formulas/products/${j}/fields`),g=y.data.fields||y.data;return r(g),g},{showToast:!1}):(r({}),{}),[m]),C=n.useCallback(async()=>m(async()=>(await O.get("/formulas/templates/list")).data),[m]),R=n.useCallback(async j=>(a(!0),m(async()=>{const y=await O.post("/formulas",j);return x("Formula created successfully!"),y.data}).finally(()=>{a(!1)})),[m,x]),u=n.useCallback(async(j,y)=>(a(!0),m(async()=>{const g=await O.put(`/formulas/${j}`,y);return x("Formula updated successfully!"),g.data}).finally(()=>{a(!1)})),[m,x]),k=n.useCallback(async j=>(a(!0),m(async()=>{const y=await O.delete(`/formulas/${j}`);return x("Formula deleted successfully!"),y.data}).finally(()=>{a(!1)})),[m,x]),T=n.useCallback(()=>{d(null),i(null)},[]),U=n.useCallback((j,y=5)=>{const g=[],A=Object.keys(j);for(let f=0;f<y;f++){const v={};A.forEach(w=>{w.includes("amount")||w.includes("balance")?v[w]=Math.random()*1e4:w.includes("rate")||w.includes("percentage")?v[w]=Math.random()*100:w.includes("date")?v[w]=new Date(Date.now()-Math.random()*365*24*60*60*1e3):w.includes("status")?v[w]=["active","inactive","pending"][Math.floor(Math.random()*3)]:v[w]=`Value_${f+1}`}),g.push(v)}return g},[]);return{loading:s,validationResult:o,testResult:b,productFields:N,validateFormula:l,testFormula:F,getFieldSuggestions:I,getProductFields:_,getFormulaTemplates:C,createFormula:R,updateFormula:u,deleteFormula:k,clearResults:T,generateSampleData:U,setValidationResult:d,setTestResult:i,setProductFields:r}};function ds({formula:s=null,onSubmit:a,onCancel:o,products:d=[],returnTypes:b=[],supportedOperations:i=[],fieldSuggestions:N={},functionDocumentation:r={},isSubmitting:x=!1,submitLabel:m="Save Formula"}){var ee,se;const[l,F]=n.useState({name:(s==null?void 0:s.name)||"",expression:(s==null?void 0:s.expression)||"",description:(s==null?void 0:s.description)||"",product_id:(s==null?void 0:s.product_id)||"",return_type:(s==null?void 0:s.return_type)||"numeric",is_active:(s==null?void 0:s.is_active)??!0,parameters:(s==null?void 0:s.parameters)||{}}),[I,_]=n.useState(!1),[C,R]=n.useState(!1),[u,k]=n.useState(null),[T,U]=n.useState([]),[j,y]=n.useState([]),[g,A]=n.useState(!1),{loading:f,validationResult:v,testResult:w,productFields:V,validateFormula:B,testFormula:W,getProductFields:q,generateSampleData:$,setValidationResult:H,setTestResult:c}=Ze();n.useEffect(()=>{l.product_id&&q(l.product_id)},[l.product_id,q]);const p=(t,h)=>{F(S=>({...S,[t]:h})),t==="expression"&&(H(null),c(null),h&&h!==l.expression&&y(S=>[{expression:h,timestamp:new Date},...S.slice(0,9)]))},M=async t=>{if(t.trim())try{await B(t,l.product_id||null)}catch{}},E=()=>{if(!l.product_id)return;const t=$(V,5);U(t)},D=()=>{navigator.clipboard.writeText(l.expression)},L=()=>{const t={name:l.name,expression:l.expression,description:l.description,return_type:l.return_type,parameters:l.parameters,exported_at:new Date().toISOString()},h=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),S=URL.createObjectURL(h),z=document.createElement("a");z.href=S,z.download=`${l.name||"formula"}.json`,z.click(),URL.revokeObjectURL(S)},G=async()=>{if(l.expression.trim())try{const t=await B(l.expression,l.product_id||null)}catch{}},me=async()=>{if(!(v!=null&&v.valid)){alert("Please validate the formula first");return}try{const t=await W(l.expression,l.product_id||null,T.length>0?T:null)}catch{}},ue=t=>{t.preventDefault(),l.name.trim()&&l.expression.trim()&&a(l)},he=t=>{F(h=>({...h,name:h.name||t.name,expression:t.expression,description:h.description||t.description})),_(!1),H(null),c(null)};return e.jsxs("form",{onSubmit:ue,children:[e.jsxs("div",{className:"row g-3 mb-4",children:[e.jsx("div",{className:"col-lg-3 col-md-6",children:e.jsxs("div",{className:"mb-0",children:[e.jsx("label",{className:"form-label required",children:"Formula Name"}),e.jsx("input",{type:"text",className:"form-control form-control-lg",value:l.name,onChange:t=>p("name",t.target.value),placeholder:"Enter formula name",required:!0})]})}),e.jsx("div",{className:"col-lg-3 col-md-6",children:e.jsxs("div",{className:"mb-0",children:[e.jsx("label",{className:"form-label required",children:"Return Type"}),e.jsx("select",{className:"form-select form-select-lg",value:l.return_type,onChange:t=>p("return_type",t.target.value),children:b.map(t=>e.jsx("option",{value:t,children:t.charAt(0).toUpperCase()+t.slice(1)},t))})]})}),e.jsx("div",{className:"col-lg-3 col-md-6",children:e.jsxs("div",{className:"mb-0",children:[e.jsx("label",{className:"form-label",children:"Status"}),e.jsxs("div",{className:"form-check form-switch mt-2",children:[e.jsx("input",{className:"form-check-input",type:"checkbox",checked:l.is_active,onChange:t=>p("is_active",t.target.checked)}),e.jsx("label",{className:"form-check-label",children:l.is_active?"Active":"Inactive"})]})]})}),e.jsx("div",{className:"col-lg-3 col-md-6",children:e.jsxs("div",{className:"mb-0",children:[e.jsx("label",{className:"form-label",children:"Quick Actions"}),e.jsxs("div",{className:"d-flex flex-column gap-2",children:[e.jsx("button",{type:"button",className:"btn btn-outline-primary btn-sm",onClick:()=>p("return_type","numeric"),children:"Set Numeric Return"}),e.jsx("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>p("return_type","percentage"),children:"Set Percentage Return"})]})]})})]}),e.jsxs("div",{className:"row g-3 mb-4",children:[e.jsx("div",{className:"col-lg-6 col-md-8",children:e.jsxs("div",{className:"mb-0",children:[e.jsx("label",{className:"form-label",children:"Product (Optional)"}),e.jsxs("select",{className:"form-select form-select-lg",value:((ee=l.product_id)==null?void 0:ee.toString())||"",onChange:t=>p("product_id",t.target.value||null),children:[e.jsx("option",{value:"",children:"Select a Product (Optional)"}),d.map(t=>e.jsxs("option",{value:t.id.toString(),children:[t.name," (",t.category,")"]},t.id))]}),e.jsx("div",{className:"form-hint",children:"Select a product to get field suggestions and product-specific validation"})]})}),e.jsx("div",{className:"col-lg-6 col-md-4",children:e.jsxs("div",{className:"mb-0",children:[e.jsx("label",{className:"form-label",children:"Description"}),e.jsx("textarea",{className:"form-control",rows:"3",value:l.description,onChange:t=>p("description",t.target.value),placeholder:"Describe what this formula calculates"})]})})]}),l.product_id&&Object.keys(V).length>0&&e.jsx("div",{className:"row mb-4",children:e.jsx("div",{className:"col-12",children:e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsxs("h4",{className:"card-title",children:["Available Fields for ",(se=d.find(t=>t.id.toString()===l.product_id.toString()))==null?void 0:se.name]})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"row g-2",children:Object.entries(V).map(([t,h])=>e.jsx("div",{className:"col-xl-2 col-lg-3 col-md-4 col-sm-6",children:e.jsx("div",{className:"card card-sm border-primary",children:e.jsx("div",{className:"card-body p-2",children:e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsxs("div",{className:"flex-grow-1",children:[e.jsx("div",{className:"fw-bold text-primary small",children:t}),e.jsx("div",{className:"text-muted",style:{fontSize:"0.7rem"},children:h})]}),e.jsx("button",{type:"button",className:"btn btn-primary btn-sm ms-2",style:{fontSize:"0.7rem",padding:"0.2rem 0.4rem"},onClick:()=>{const S=l.expression+(l.expression?" ":"")+t;p("expression",S)},children:"+"})]})})})},t))})})]})})}),e.jsx("div",{className:"row mb-4",children:e.jsx("div",{className:"col-12",children:e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsxs("div",{className:"d-flex align-items-center justify-content-between",children:[e.jsx("h4",{className:"card-title",children:"Formula Expression"}),e.jsxs("button",{type:"button",className:"btn btn-outline-primary btn-sm",onClick:()=>_(!I),children:[e.jsx(Q,{size:16,className:"me-1"}),"Templates"]})]})}),e.jsxs("div",{className:"card-body",children:[I&&e.jsx("div",{className:"mb-3",children:e.jsx(Xe,{onSelect:he})}),e.jsx("div",{className:"mb-3",children:e.jsx(Ie,{value:l.expression,onChange:t=>p("expression",t),supportedOperations:i,availableFields:V,placeholder:"Enter your formula expression (e.g., SUM(amount) + AVG(balance))",validationResult:v,onValidate:M})}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[e.jsxs("div",{className:"btn-group",children:[e.jsxs("button",{type:"button",className:"btn btn-outline-success",onClick:G,disabled:f||!l.expression.trim(),children:[f?e.jsx("div",{className:"spinner-border spinner-border-sm me-2",role:"status"}):e.jsx(Z,{size:16,className:"me-1"}),"Validate"]}),(v==null?void 0:v.valid)&&e.jsxs("button",{type:"button",className:"btn btn-outline-primary",onClick:me,children:[e.jsx(Ee,{size:16,className:"me-1"}),"Test with Data"]}),l.product_id&&e.jsxs("button",{type:"button",className:"btn btn-outline-info",onClick:E,children:[e.jsx(we,{size:16,className:"me-1"}),"Generate Test Data"]})]}),e.jsxs("div",{className:"btn-group",children:[e.jsx("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:D,disabled:!l.expression.trim(),title:"Copy formula to clipboard",children:e.jsx(Ce,{size:14})}),e.jsx("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:L,disabled:!l.expression.trim(),title:"Export formula as JSON",children:e.jsx(ke,{size:14})})]})]}),v&&e.jsx("div",{className:"mt-3",children:e.jsx(Qe,{result:v})}),T.length>0&&e.jsx("div",{className:"mt-3",children:e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h6",{className:"card-title",children:"Generated Test Data"})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"table-responsive",children:e.jsxs("table",{className:"table table-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"#"}),Object.keys(T[0]||{}).map(t=>e.jsx("th",{children:t},t))]})}),e.jsx("tbody",{children:T.map((t,h)=>e.jsxs("tr",{children:[e.jsx("td",{children:h+1}),Object.values(t).map((S,z)=>e.jsx("td",{children:typeof S=="number"?S.toFixed(2):String(S)},z))]},h))})]})})})]})}),w&&e.jsx("div",{className:"mt-3",children:e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h5",{className:"card-title",children:"Test Results"})}),e.jsx("div",{className:"card-body",children:w.execution_result!==null?e.jsxs("div",{className:"d-flex align-items-center text-success",children:[e.jsx(Z,{size:16,className:"me-2"}),e.jsxs("span",{children:["Result: ",w.execution_result]})]}):w.execution_error?e.jsxs("div",{className:"d-flex align-items-center text-danger",children:[e.jsx(K,{size:16,className:"me-2"}),e.jsxs("span",{children:["Error: ",w.execution_error]})]}):null})]})})]})]})})}),j.length>0&&e.jsx("div",{className:"row mb-4",children:e.jsx("div",{className:"col-12",children:e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsxs("div",{className:"d-flex align-items-center justify-content-between",children:[e.jsxs("h5",{className:"card-title",children:[e.jsx(Q,{size:20,className:"me-2"}),"Formula History"]}),e.jsx("button",{type:"button",className:"btn btn-outline-secondary btn-sm",onClick:()=>A(!g),children:g?e.jsxs(e.Fragment,{children:[e.jsx(le,{size:16,className:"me-1"}),"Hide History"]}):e.jsxs(e.Fragment,{children:[e.jsx(ne,{size:16,className:"me-1"}),"Show History"]})})]})}),g&&e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"list-group",children:j.map((t,h)=>e.jsxs("div",{className:"list-group-item",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-start",children:[e.jsx("div",{className:"flex-grow-1",children:e.jsx("code",{className:"small",children:t.expression})}),e.jsx("div",{className:"ms-3",children:e.jsx("button",{type:"button",className:"btn btn-outline-primary btn-sm",onClick:()=>p("expression",t.expression),children:"Restore"})})]}),e.jsx("small",{className:"text-muted",children:t.timestamp.toLocaleString()})]},h))})})]})})}),e.jsx("div",{className:"row mb-4",children:e.jsx("div",{className:"col-12",children:e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsxs("div",{className:"d-flex align-items-center justify-content-between",children:[e.jsxs("h5",{className:"card-title",children:[e.jsx(Q,{size:20,className:"me-2"}),"Function Reference & Examples"]}),e.jsx("button",{type:"button",className:"btn btn-outline-primary btn-sm",onClick:()=>R(!C),children:C?e.jsxs(e.Fragment,{children:[e.jsx(le,{size:16,className:"me-1"}),"Hide Details"]}):e.jsxs(e.Fragment,{children:[e.jsx(ne,{size:16,className:"me-1"}),"Show Details"]})})]})}),e.jsx("div",{className:"card-body",children:C?e.jsx("div",{className:"row g-3",children:Object.entries(r).map(([t,h])=>e.jsx("div",{className:"col-lg-6 col-xl-4",children:e.jsxs("div",{className:"card card-sm border",children:[e.jsx("div",{className:"card-header bg-light",children:e.jsxs("div",{className:"d-flex align-items-center justify-content-between",children:[e.jsx("h6",{className:"card-title mb-0 text-primary",children:t}),e.jsx("span",{className:`badge ${h.category==="aggregation"?"bg-primary":h.category==="conditional"?"bg-warning":h.category==="calculation"?"bg-success":h.category==="statistical"?"bg-info":"bg-secondary"}`,children:h.category})]})}),e.jsxs("div",{className:"card-body",children:[e.jsx("p",{className:"small mb-2",children:h.description}),e.jsxs("div",{className:"mb-2",children:[e.jsx("strong",{className:"small",children:"Syntax:"}),e.jsx("code",{className:"small ms-1",children:h.syntax})]}),h.examples&&e.jsxs("div",{className:"mb-2",children:[e.jsx("strong",{className:"small",children:"Examples:"}),e.jsx("ul",{className:"small mb-0 mt-1",children:Object.entries(h.examples).map(([S,z])=>e.jsxs("li",{children:[e.jsx("code",{className:"small",children:S}),e.jsx("br",{}),e.jsx("span",{className:"text-muted",children:z})]},S))})]}),h.use_cases&&e.jsxs("div",{className:"mb-2",children:[e.jsx("strong",{className:"small",children:"Use Cases:"}),e.jsx("ul",{className:"small mb-0 mt-1",children:h.use_cases.map((S,z)=>e.jsx("li",{children:S},z))})]}),h.note&&e.jsxs("div",{className:"alert alert-info alert-sm mb-0",children:[e.jsx(oe,{size:14,className:"me-1"}),e.jsx("small",{children:h.note})]})]})]})},t))}):e.jsx("div",{className:"d-flex flex-wrap gap-1",children:Object.keys(r).map(t=>e.jsx("button",{type:"button",className:"btn btn-outline-primary btn-sm",onClick:()=>{k(t),R(!0)},children:t},t))})})]})})}),e.jsx("div",{className:"card-footer bg-transparent mt-auto",children:e.jsxs("div",{className:"btn-list justify-content-end",children:[e.jsx("button",{type:"button",className:"btn",onClick:o,disabled:x,children:"Cancel"}),e.jsxs("button",{type:"submit",className:"btn btn-primary",disabled:x,children:[x&&e.jsx("div",{className:"spinner-border spinner-border-sm me-2",role:"status"}),m]})]})})]})}export{ds as F,Je as u};
